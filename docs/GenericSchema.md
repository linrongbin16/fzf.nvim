<!-- markdownlint-disable MD013 MD034 MD033 MD038 MD051 MD040 MD036 -->

# A Generic Schema for Creating FZF Command

## Table of Contents

- [Introduction](#introduction)
- [Context](#context)
- [Shutdown](#shutdown)
- [Provider](#provider)
- [Provider Decorator](#provider-decorator)
- [Previewer](#previewer)
- [Previewer Label](#previewer-label)
- [Command Feed](#command-feed)
- [Fzf Option](#fzf-option)
- [Interaction/Action](#interactionaction)
- [Pipeline](#pipeline)
- [Command Group](#command-group)

## Introduction

A fzf-based search command usually consists of below components:

- **Provider**: A shell command that generates the lines for (the left side of) the fzf binary.

  - (Optional) **Provider Decorator**: A lua function that modifies the generated lines. For example `FzfxFiles` prepends file type icons for each line generated by provider `fd`/`find` command.

- **Previewer**: A shell command that generates the contents to preview the current line under cursor/marker in the fzf's (right side of) preview window.

  - (Optional) **Previewer Label**: A label (string) on the top of fzf's preview window, which gives extra hint and summary.

- **Action**: A key that first quits fzf's interactive window, then invokes a registered lua function with selected lines. For example, press `ENTER` key in `FzfxFiles` will quit popup window and open all the selected files.
- (Optional) **Interaction**: A key that invokes a registered lua function but doesn't quit the fzf binary. For example, press `CTRL-U`/`CTRL-R` key in `FzfxFiles` will switch between **unrestricted mode** and **restricted mode**.
- (Optional) **Fzf Option**: Other fzf options that control the fzf binary's layout/border/etc.
- (Optional) **Other Option**: Other special options that control some specific searching behavior, for example live reloading, popup window layout, etc.

This is a [producer-consumer pattern](https://en.wikipedia.org/wiki/Producer%E2%80%93consumer_problem), i.e. **Provider** is the data producer, **Previewer** and **Action**/**Interaction** are the data consumers. We also say it's a dataflow, when putting all these components together, it's named a **Pipeline** in this plugin.

With this pattern, all the details of launching the fzf shell command and interacting across different child processes within nvim editor are hidden, only a friendly config layer is provided to user and allows third-party plugin developers to create almost any searching commands on their own needs.

Let's define it more specifically.

> Also see [`schema.lua`](https://github.com/linrongbin16/fzfx.nvim/blob/main/lua/fzfx/schema.lua).

## Context

A **context** is some data that passing to pipeline.

Starting a searching command is actually creating a popup window and a terminal, running a fzf shell command inside it. Thus there's no way to get the current buffer number (`bufnr`) or current window number (`winnr`) you're editing (actually it's the _previous_ buffer/window).

So we need a way to store the **_current_** buffer/window info in somewhere, so we need to create a context before creating the popup window and launching the shell command.

## Shutdown

A **shutdown** is some operations that will be invoked when a search is complete, it recycles all the resources allocated during the search.

For example a **context** create a temporary file to help passing data between providers/previewers. Thus we also needs a **shutdown** to delete the temporary file when the search complete.

## Provider

A **provider** is a component that can generate data sources (the lines) for (the left side of) the fzf command.

When this plugin starts, it prepares data sources for the fzf command, and then launch a child process to feed these data sources to the fzf command. Since the `nvim` can be used as a lua interpreter, a headless Neovim editor, we could leverage it as a Neovim-editor-as-a-VM runtime and archives a lot of functions, including running a shell command, send GRPC call to the Neovim editor (users are using), etc.

> Also see: [fzfx's architecture](https://linrongbin16.github.io/fzfx.nvim/#/How).

We have several types of providers:

- Plain command provider: Plain lua data types (i.e. `string`, `list`, etc) that represents a shell command, which can be executed inside the child process. For example:
  - `"fd . -cnever -tf -tl -L"`: A lua string that represents a shell command (find all file names in current working directory). This plugin will evaluate it with a `bash` shell, and generate data sources for the fzf command.
  - `{"fd", ".", "-cnever", "-tf", "-tl", "-L"}`: A lua array that contains multiple strings, it also represents the same shell command with above example. This plugin will launch it by operating system (directly without a `bash` shell), and generate data sources for the fzf command.
- Functional command provider: Lua function that will be first invoked and generate result as a shell command (i.e. `string`, `list`, etc), thus which can be executed inside the child process to get the final data sources for the fzf command. The lua function can be invoked on every keystroke to arhieve the real-time live query and reloading.
- Direct provider: This is also a lua function, but it will directly generate the data sources for the fzf command, child process doesn't need to evaluate as a shell command. Because not all data sources are generated by the shell command, for example LSP symbols and diagnostics.
- Async direct provider: This is exactly same with the **direct provider**, except it is running in async mode, which will not block the Neovim UI. This is very useful if you need to run some command lines (i.e. run child processes and wait for them complete), or send requests to LSP services.

### Provider Decorator

Sometimes we want to decorate the lines generated by providers, for example we want to prepend a file type icon at the beginning of each file names in `FzfxFiles` command. Here comes the **provider decorator**, it's a lua function that runs with a line as parameter, and returns a decorated line.

We have several types of provider decorators:

- File name decorator, it works for providers that generate file names as data sources. For example `FzfxFiles`, `FzfxBuffers`, etc.
- Grep decorator, it works for providers that generate grep results in format `{FileName}:{Line}:{Column}:{Text}` as data sources. For example `FzfxLiveGrep`, `FzfxGLiveGrep`, etc.

**Please always keep in mind**:

1. Decorators run inside the child process, which is outside of the Neovim editor.
2. No plugins are loaded, only standard LuaJIT and Neovim APIs are available.

## Previewer

A **previewer** is a component that uses current line as input, and generates data contents for the fzf command preview window (in the right side).

Similar to provider, previewer also prepares the data contents for the fzf command, and then launch a child process to feed these data contents to the fzf command.

We have several types of previewers:

- Plain command previewer: Similar to **plain command provider**, it is plain lua data types that represents a shell command.
- Functional command previewer: Similar to the **functional command provider**, it is a lua function that could be invoke and generate result as a shell command.
- Direct previewer (not implemented): Similar to **direct provider**, it is a lua function that can directly generated data source for fzf preview window, child process doesn't need to evaluate as a shell command.

### Previewer Label

Sometimes we want to give a name to the preview window, for example we want to set the title of the preview window to the file name when we preview the file content. Here comes the **previewer label**, it's a lua function that runs with a line as parameter, and returns the label string.

> Note: The lua function will be invoke on every keystroke to archive the real-time updates.

## Command Feed

A **command feed** defines how to feed the query content to the search commands, i.e. the multiple variants of a searching command.

- Argument: User can pass their query contents via the command line arguments.
- Cursor word: User can pass their query contents by the word under cursor.
- Visual select: User can pass their query contents by visual select.
- Yanked text: User can pass their query contents by yanked text.
- Resume last search: User can pass their query contents by resume last search.

## Fzf Option

A **fzf option** is a simple string or a pair of two strings, that directly passes to the fzf command. For example `--multi`, `--bind=ctrl-e:toggle`, `--layout=reverse`.

We have several types of fzf options:

- Plain option: A plain option as a simple string. For example `--multi`.
- Pair option: A plain option as a pair of two strings. For example `{ '--bind', 'ctrl-e:toggle' }`.
- Function option: A lua function that runs and returns above two types of fzf options.

## Interaction/Action

An **(inter)action** is a lua function that binds with a key, thus when user press it and been invoked.

We have 2 types of (inter)actions:

- Interaction: When user presses, it invokes the binded lua function with current line as parameter, without quitting popup window.
- Action: When user presses, it quits the popup window, then invokes the binded lua function with selected lines.

## Pipeline

A **pipeline** puts a provider, a previewer, some interactions and actions together, bring us the dataflow.

## Command Group

When facing the real-world searching command we're using, say `FzfxLiveGrep`, it actually contains:

- Multiple variants: Basic variant (`args`) that feeds with user arguments, visual select variant (`visual`) that feeds with visual selections, cursor word variant (`cword`) that feeds with cursor word, etc.
- Multiple data sources: Each data source has a unique provider/previewer and interaction (to let user switch to it). Note: If a searching command only contains 1 provider and previewer, it's not necessary to contain the interaction (because user has nothing to switch to).
- Multiple previewers: Each binds to a provider.
- Multiple actions: Allow user to do anything with selected lines when quitting popup window.
- (Optionally) Multiple interactions: Allow user to do anything without quitting popup window.
- (Optionally) Extra fzf options and other options: Some other configurations.
